MERGE INTO usuario AS c
USING (SELECT ${CodigoUsuario} AS codigo_usuario) AS u
ON EXISTS (
    SELECT 1 
    FROM usuario 
    WHERE codigo_usuario = u.codigo_usuario
)
WHEN MATCHED THEN 
    UPDATE SET 
        c.codigo_cliente = ${CodigoCliente},
        c.codigo_empresa = ${CodigoEmpresa},
        c.login = '${Login}',
        c.nome = '${Nome}',
        c.email = '${Email}',
        c.url = '${Url}',
        c.lider = CAST(CASE WHEN '${Lider}' = 'True' THEN 1 ELSE 0 END AS INT),
        c.ativo = CAST(CASE WHEN '${Ativo}' = 'True' THEN 1 ELSE 0 END AS INT),
        c.atualizar_senha = CAST(CASE WHEN '${AtualizarSenha}' = 'True' THEN 1 ELSE 0 END AS INT),
        c.segredo_otp = '${SegredoOTP}',
        c.validou_otp = CAST(CASE WHEN '${ValidouOTP}' = 'True' THEN 1 ELSE 0 END AS INT),
        c.cnpj_fornecedor = '${CnpjFornecedor}',
        c.criado_por = COALESCE(NULLIF('${CriadoPor}', ''), NULL),
        c.criado_em = CASE 
                        WHEN '${CriadoEm}' IS NOT NULL AND LTRIM(RTRIM('${CriadoEm}')) != '' 
                        THEN REPLACE('${CriadoEm}', 'T', ' ')
                        ELSE NULL 
                     END,
        c.alterado_por = COALESCE(NULLIF('${AlteradoPor}', ''), NULL),
        c.alterado_em = CASE 
                        WHEN '${AlteradoEm}' IS NOT NULL AND LTRIM(RTRIM('${AlteradoEm}')) != '' 
                        THEN REPLACE('${AlteradoEm}', 'T', ' ')
                        ELSE NULL 
                     END,
        c.excluido_por = COALESCE(NULLIF('${ExcluidoPor}', ''), NULL),
        c.excluido_em = CASE 
                        WHEN '${ExcluidoEm}' IS NOT NULL AND LTRIM(RTRIM('${ExcluidoEm}')) != '' 
                        THEN REPLACE('${ExcluidoEm}', 'T', ' ')
                        ELSE NULL 
                     END
WHEN NOT MATCHED THEN 
    INSERT (codigo_usuario, codigo_cliente, codigo_empresa, login, nome, email, url, lider, ativo, 
            atualizar_senha, segredo_otp, validou_otp, cnpj_fornecedor, criado_por, criado_em, 
            alterado_por, alterado_em, excluido_por, excluido_em)
    VALUES (
        ${CodigoUsuario},
        ${CodigoCliente},
        ${CodigoEmpresa},
        '${Login}',
        '${Nome}',
        '${Email}',
        '${Url}',
        CAST(CASE WHEN '${Lider}' = 'True' THEN 1 ELSE 0 END AS INT),
        CAST(CASE WHEN '${Ativo}' = 'True' THEN 1 ELSE 0 END AS INT),
        CAST(CASE WHEN '${AtualizarSenha}' = 'True' THEN 1 ELSE 0 END AS INT),
        '${SegredoOTP}',
        CAST(CASE WHEN '${ValidouOTP}' = 'True' THEN 1 ELSE 0 END AS INT),
        '${CnpjFornecedor}',
        COALESCE(NULLIF('${CriadoPor}', ''), NULL),
        CASE 
            WHEN '${CriadoEm}' IS NOT NULL AND LTRIM(RTRIM('${CriadoEm}')) != '' 
            THEN REPLACE('${CriadoEm}', 'T', ' ')
            ELSE NULL 
        END,
        COALESCE(NULLIF('${AlteradoPor}', ''), NULL),
        CASE 
            WHEN '${AlteradoEm}' IS NOT NULL AND LTRIM(RTRIM('${AlteradoEm}')) != '' 
            THEN REPLACE('${AlteradoEm}', 'T', ' ')
            ELSE NULL 
        END,
        COALESCE(NULLIF('${ExcluidoPor}', ''), NULL),
        CASE 
            WHEN '${ExcluidoEm}' IS NOT NULL AND LTRIM(RTRIM('${ExcluidoEm}')) != '' 
            THEN REPLACE('${ExcluidoEm}', 'T', ' ')
            ELSE NULL 
        END
    );
