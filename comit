DECLARE @codigo_usuario DECIMAL(18,0) = TRY_CONVERT(DECIMAL(18,0), '${CodigoUsuario}'),
        @codigo_cliente DECIMAL(18,0) = CASE WHEN NULLIF('${CodigoCliente}', '') IS NOT NULL THEN TRY_CONVERT(DECIMAL(18,0), '${CodigoCliente}') ELSE NULL END,
        @codigo_empresa DECIMAL(18,0) = CASE WHEN NULLIF('${CodigoEmpresa}', '') IS NOT NULL THEN TRY_CONVERT(DECIMAL(18,0), '${CodigoEmpresa}') ELSE NULL END,
        @login VARCHAR(40) = CASE WHEN NULLIF('${Login:replace("'", "''")}', '') IS NOT NULL THEN '${Login:replace("'", "''")}' ELSE NULL END,
        @senha BINARY(32) = CASE WHEN NULLIF('${Senha}', '') IS NOT NULL THEN CONVERT(BINARY(32), '${Senha}') ELSE NULL END,
        @nome VARCHAR(255) = CASE WHEN NULLIF('${Nome:replace("'", "''")}', '') IS NOT NULL THEN '${Nome:replace("'", "''")}' ELSE NULL END,
        @email VARCHAR(255) = CASE WHEN NULLIF('${Email:replace("'", "''")}', '') IS NOT NULL THEN '${Email:replace("'", "''")}' ELSE NULL END,
        @url VARCHAR(255) = CASE WHEN NULLIF('${Url:replace("'", "''")}', '') IS NOT NULL THEN '${Url:replace("'", "''")}' ELSE NULL END,
        @lider BIT = CASE WHEN NULLIF('${Lider}', '') IS NOT NULL THEN CASE WHEN LOWER('${Lider}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @ativo BIT = CASE WHEN NULLIF('${Ativo}', '') IS NOT NULL THEN CASE WHEN LOWER('${Ativo}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @atualizar_senha BIT = CASE WHEN NULLIF('${AtualizarSenha}', '') IS NOT NULL THEN CASE WHEN LOWER('${AtualizarSenha}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @integrado BIT = CASE WHEN NULLIF('${Integrado}', '') IS NOT NULL THEN CASE WHEN LOWER('${Integrado}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @validou_otp BIT = CASE WHEN NULLIF('${ValidouOtp}', '') IS NOT NULL THEN CASE WHEN LOWER('${ValidouOtp}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @excluido BIT = CASE WHEN NULLIF('${Excluido}', '') IS NOT NULL THEN CASE WHEN LOWER('${Excluido}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @requer_mfa BIT = CASE WHEN NULLIF('${RequerMfa}', '') IS NOT NULL THEN CASE WHEN LOWER('${RequerMfa}') = 'true' THEN 1 ELSE 0 END ELSE NULL END,
        @segredo_otp NVARCHAR(32) = CASE WHEN NULLIF('${SegredoOtp:replace("'", "''")}', '') IS NOT NULL THEN '${SegredoOtp:replace("'", "''")}' ELSE NULL END,
        @cnpj_fornecedor VARCHAR(25) = CASE WHEN NULLIF('${CnpjFornecedor:replace("'", "''")}', '') IS NOT NULL THEN '${CnpjFornecedor:replace("'", "''")}' ELSE NULL END,
        @criado_por DECIMAL(18,0) = CASE WHEN NULLIF('${CriadoPor}', '') IS NOT NULL THEN TRY_CONVERT(DECIMAL(18,0), '${CriadoPor}') ELSE NULL END,
        @criado_em DATETIME = CASE WHEN NULLIF('${CriadoEm}', '') IS NOT NULL THEN TRY_CONVERT(DATETIME, REPLACE('${CriadoEm}', 'T', ' ')) ELSE NULL END,
        @alterado_por DECIMAL(18,0) = CASE WHEN NULLIF('${AlteradoPor}', '') IS NOT NULL THEN TRY_CONVERT(DECIMAL(18,0), '${AlteradoPor}') ELSE NULL END,
        @alterado_em DATETIME = CASE WHEN NULLIF('${AlteradoEm}', '') IS NOT NULL THEN TRY_CONVERT(DATETIME, REPLACE('${AlteradoEm}', 'T', ' ')) ELSE NULL END,
        @excluido_por DECIMAL(18,0) = CASE WHEN NULLIF('${ExcluidoPor}', '') IS NOT NULL THEN TRY_CONVERT(DECIMAL(18,0), '${ExcluidoPor}') ELSE NULL END,
        @excluido_em DATETIME = CASE WHEN NULLIF('${ExcluidoEm}', '') IS NOT NULL THEN TRY_CONVERT(DATETIME, REPLACE('${ExcluidoEm}', 'T', ' ')) ELSE NULL END;




		IF EXISTS (SELECT 1 FROM usuario WHERE codigo_usuario = @codigo_usuario)
BEGIN
    UPDATE usuario SET 
        codigo_cliente = @codigo_cliente,
        codigo_empresa = @codigo_empresa,
        login = @login,
        senha = @senha,
        nome = @nome,
        email = @email,
        url = @url,
        lider = @lider,
        ativo = @ativo,
        atualizar_senha = @atualizar_senha,
        integrado = @integrado,
        segredo_otp = @segredo_otp,
        validou_otp = @validou_otp,
        cnpj_fornecedor = @cnpj_fornecedor,
        criado_por = @criado_por,
        criado_em = @criado_em,
        alterado_por = @alterado_por,
        alterado_em = @alterado_em,
        excluido = @excluido,
        excluido_por = @excluido_por,
        excluido_em = @excluido_em,
        requer_mfa = @requer_mfa
    WHERE codigo_usuario = @codigo_usuario
END
ELSE
BEGIN
    INSERT INTO usuario ( 
		codigo_usuario,
        codigo_cliente,
        codigo_empresa,
        login,
        senha,
        nome,
        email,
        url,
        lider,
        ativo,
        atualizar_senha,
        integrado,
        segredo_otp,
        validou_otp,
        cnpj_fornecedor,
        criado_por,
        criado_em,
        alterado_por,
        alterado_em,
        excluido,
        excluido_por,
        excluido_em,
        requer_mfa)
    VALUES(
		@codigo_usuario,
        @codigo_cliente,
        @codigo_empresa,
        @login,
        CONVERT(BINARY(32), @senha),
        @nome,
        @email,
        @url,
        @lider,
        @ativo,
        @atualizar_senha,
        @integrado,
        @segredo_otp,
        @validou_otp,
        @cnpj_fornecedor,
        @criado_por,
        @criado_em,
        @alterado_por,
        @alterado_em,
        @excluido,
        @excluido_por,
        @excluido_em,
        @requer_mfa)
END
